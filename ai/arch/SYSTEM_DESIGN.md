# FantasyNovelAgent å¼€å‘æŒ‡å—

è¿™ä»½æ–‡æ¡£æ—¨åœ¨å¸®åŠ©å¼€å‘è€…ï¼ˆåŒ…æ‹¬äººç±»å¼€å‘è€…å’Œ AI Agentï¼‰å¿«é€Ÿç†è§£ `FantasyNovelAgent` é¡¹ç›®çš„æ¶æ„ã€é€»è¾‘æµå’Œæ•°æ®ç»“æ„ï¼Œä»¥ä¾¿å¿«é€Ÿä¸Šæ‰‹è¿›è¡Œç»´æŠ¤æˆ–åŠŸèƒ½æ‰©å±•ã€‚

## 1. é¡¹ç›®ç®€ä»‹
`FantasyNovelAgent` æ˜¯ä¸€ä¸ªåŸºäº Streamlit çš„å¤šæ™ºèƒ½ä½“ï¼ˆMulti-Agentï¼‰å°è¯´åˆ›ä½œè¾…åŠ©ç³»ç»Ÿï¼Œä¸“ä¸ºåˆ›ä½œç°ä»£ç„å¹»é£æ ¼ï¼ˆçˆ½æ–‡ï¼‰å°è¯´è®¾è®¡ã€‚ç³»ç»Ÿé€šè¿‡å¤šä¸ªä¸“èŒ Agent åä½œï¼Œå®ç°ä»çµæ„Ÿæ¨æ¼”ã€å¤§çº²ç”Ÿæˆã€æ­£æ–‡æ’°å†™ã€æ–‡é£æ¶¦è‰²åˆ°é€»è¾‘æ£€æŸ¥çš„å…¨æµç¨‹è¾…åŠ©ï¼Œå¹¶å…·å¤‡è‡ªåŠ¨åŒ–çš„è®°å¿†ç®¡ç†åŠŸèƒ½ã€‚


## 2. ç›®å½•ç»“æ„è¯´æ˜

```text
FantasyNovelAgent/
â”œâ”€â”€ app.py                  # [å…¥å£] åº”ç”¨ç¨‹åºä¸»å…¥å£ï¼ŒUI æ¸²æŸ“ä¸é€»è¾‘æ§åˆ¶ä¸­å¿ƒ
â”œâ”€â”€ config.py               # [é…ç½®] ç¯å¢ƒå˜é‡ä¸ API é…ç½®ç®¡ç†
â”œâ”€â”€ deploy.sh               # [éƒ¨ç½²] Mac -> Pi ä¸€é”®éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ DEPLOY_PI.md            # [æ–‡æ¡£] æ ‘è“æ´¾è¯¦ç»†éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ DEVELOPER_GUIDE.md       # [æ–‡æ¡£] å¼€å‘æŒ‡å—ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ DATA_STRUCTURE.md        # [æ–‡æ¡£] æ•°æ®ç»“æ„è¯´æ˜
â”œâ”€â”€ requirements.txt        # [ä¾èµ–] Python ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ .env.example            # [ç¯å¢ƒ] ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
â”œâ”€â”€ .gitignore              # [Git] ç‰ˆæœ¬æ§åˆ¶å¿½ç•¥é…ç½®
â”œâ”€â”€ data/                   # [æ•°æ®] æ•°æ®æŒä¹…åŒ–ç›®å½•
â”‚   â”œâ”€â”€ config/             # å­˜æ”¾ model_profiles.json (æ¨¡å‹é…ç½®)
â”‚   â”œâ”€â”€ logs/               # è¿è¡Œæ—¥å¿—ä¸æŒ‡æ ‡ç›¸å…³è¾“å‡ºï¼ˆapp.log/usage_stats.json ç­‰ï¼Œè¿è¡Œæ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ novel.db            # [æ ¸å¿ƒ] SQLite æ•°æ®åº“ (å­˜å‚¨å°è¯´æ­£æ–‡ã€è®°å¿†ã€è‰ç¨¿)
â”‚   â”œâ”€â”€ vector_db/          # [ç´¢å¼•] ChromaDB æœ¬åœ°å‘é‡ç´¢å¼•ï¼ˆå¯ä» novel.db é‡å»ºï¼‰
â”‚   â””â”€â”€ chat_sessions/      # [ä¼šè¯] å¤šçª—å£èŠå¤©è®°å½•ï¼ˆJSONï¼‰
â”œâ”€â”€ .streamlit/
â”‚   â””â”€â”€ config.toml         # [é…ç½®] Streamlit æœåŠ¡å™¨é…ç½®
â”œâ”€â”€ agents/                 # [æ ¸å¿ƒ] æ™ºèƒ½ä½“å®ç°ç›®å½•
â”‚   â”œâ”€â”€ base_agent.py       # Agent åŸºç±»ï¼Œå¤„ç† LLM è°ƒç”¨ï¼ˆå« RAG æ³¨å…¥ï¼‰
â”‚   â”œâ”€â”€ muse.py             # çµæ„Ÿç¼ªæ–¯ï¼šè´Ÿè´£åˆ›æ„ã€å¤§çº²ã€æ­£æ–‡ç”Ÿæˆ
â”‚   â”œâ”€â”€ stylist.py          # é£æ ¼ç»Ÿå¾¡è€…ï¼šè´Ÿè´£æ–‡é£æ¶¦è‰²
â”‚   â”œâ”€â”€ guard.py            # é€»è¾‘å®ˆå«ï¼šè´Ÿè´£é€»è¾‘æ£€æŸ¥ã€è®¾å®šå†²çªæ£€æµ‹
â”‚   â”œâ”€â”€ archivist.py        # è®°å¿†ç®¡ç†å‘˜ï¼šè´Ÿè´£æ•°æ®æå–ã€æ•´ç†ã€å½’æ¡£
â”‚   â”œâ”€â”€ world_builder.py    # [æ–°å¢] ä¸–ç•Œè§‚æ¶æ„å¸ˆï¼šè´Ÿè´£è®¾å®šç”Ÿæˆä¸è¯„ä¼°
â”‚   â”œâ”€â”€ critic.py           # [æ–°å¢] æ¯’èˆŒä¹¦è¯„äººï¼šè´Ÿè´£çˆ½ç‚¹/æ¯’ç‚¹ç‚¹è¯„
â”‚   â””â”€â”€ intent_router.py    # æ„å›¾è·¯ç”±ï¼šè¯†åˆ«ç”¨æˆ·æŒ‡ä»¤æ„å›¾
â””â”€â”€ utils/                  # [å·¥å…·] é€šç”¨å·¥å…·åº“
    â”œâ”€â”€ memory_manager.py   # æ•°æ®ä¸æ£€ç´¢é—¨é¢ï¼šSQLite + å‘é‡ç´¢å¼• + ä¸Šä¸‹æ–‡æ„å»º
    â”œâ”€â”€ storage.py          # SQLite å­˜å‚¨å±‚ï¼ˆKV/chapters/drafts/FTS5/oplog ç­‰ï¼‰
    â”œâ”€â”€ vector_manager.py   # ChromaDB å°è£…ï¼ˆcollectionã€embeddingã€queryï¼‰
    â”œâ”€â”€ chunking.py         # è¯­ä¹‰åˆ†å—ï¼ˆæŒ‰æ®µè½/å¥å­è¾¹ç•Œä¼˜å…ˆï¼‰
    â”œâ”€â”€ id_utils.py         # ULID ç”Ÿæˆï¼ˆä¸ºå¤šç«¯/è¿ç§»æ‰“åº•ï¼‰
    â”œâ”€â”€ db_manager.py       # SQLAlchemy å…³ç³»å‹æ•°æ®åº“æ¨¡å‹ä¸ç®¡ç†ï¼ˆå…³ç³»è¡¨è½åœ¨ novel.db å†…ï¼‰
    â”œâ”€â”€ model_profiles.py   # è´Ÿè´£ data/config/ ä¸‹çš„é…ç½®ç®¡ç†
    â””â”€â”€ usage_tracker.py    # [æ–°å¢] è´Ÿè´£æ¨¡å‹ç”¨é‡ç»Ÿè®¡
```

## 3. æ ¸å¿ƒäº¤äº’æµç¨‹

ç³»ç»Ÿè¿è¡Œçš„æ ¸å¿ƒé€»è¾‘æ˜¯ **Context-Action-Memory Loop**ï¼š

1.  **ä¸Šä¸‹æ–‡æ„å»º (Context Construction)**:
    - æ¯æ¬¡æ“ä½œå‰ï¼Œ`app.py` é€šè¿‡ `memory_manager.py` è¯»å–æœ€æ–°çš„å‰§æƒ…ã€è§’è‰²ã€ä¸–ç•Œè§‚å’Œæœªæ¥è§„åˆ’ï¼Œæ„å»ºå®Œæ•´çš„ä¸Šä¸‹æ–‡ (`context`)ã€‚
    - *å…³é”®ä»£ç *: `memory.get_full_context()` æˆ– `memory.get_brainstorming_context()`ã€‚

2.  **æ£€ç´¢å¢å¼º (Retrieval / RAG)**:
    - åœ¨åˆ›ä½œ/å®¡æŸ¥/é—®ç­”ç­‰ä¸»æµç¨‹è°ƒç”¨ LLM ä¹‹å‰ï¼Œç³»ç»Ÿä¼šè¿›è¡Œæ£€ç´¢å¢å¼ºï¼ŒæŠŠå‘½ä¸­çš„åŸæ–‡ç‰‡æ®µæ³¨å…¥åˆ° `context['rag_context']`ã€‚
    - æ£€ç´¢å¼•æ“ä¸ºâ€œåŒå¼•æ“å¹¶åˆ—â€ï¼š
      - **FTS5ï¼ˆå…³é”®è¯æ£€ç´¢ï¼‰**ï¼šé€‚åˆäººå/åœ°å/æ³•å®ç­‰ç¡®å®šæ€§åè¯æŸ¥è¯¢ã€‚
      - **å‘é‡æ£€ç´¢ï¼ˆè¯­ä¹‰ç›¸ä¼¼ï¼‰**ï¼šé€‚åˆæ°›å›´/å£ç™–/ç›¸ä¼¼åœºæ™¯å¬å›ã€‚
    - ä¸»çª—å£æä¾›æ¨¡å¼åˆ‡æ¢ï¼šHybrid / ä»…å…³é”®è¯ / ä»…è¯­ä¹‰ã€‚
    - æ³¨å…¥ä½ç½®ï¼š`BaseAgent._inject_rag()` ä¼šæŠŠ `rag_context` æ‹¼æ¥åˆ°ç”¨æˆ·æ¶ˆæ¯é‡Œã€‚

```mermaid
flowchart LR
  U[ç”¨æˆ·è¾“å…¥] --> UI[Streamlit UI]
  UI --> CM[ContextManager]
  CM --> DB[(data/novel.db)]
  UI --> RAG[æ£€ç´¢å¢å¼ºï¼ˆRAGï¼‰]
  RAG --> FTS[FTS5\nå…³é”®è¯æ£€ç´¢]
  RAG --> VEC[å‘é‡æ£€ç´¢\nChromaDB]
  FTS --> DB
  VEC --> CH[(data/vector_db/)]
  CH --> EMB{Embedding åç«¯\nhf/onnx/openai}
  RAG --> CTX[context.rag_context]
  UI -->|æ³¨å…¥ rag_context| AG[Agent]
  CTX --> AG
```

3.  **æ™ºèƒ½ä½“è¡ŒåŠ¨ (Agent Action)**:
    - ç”¨æˆ·è¾“å…¥é€šè¿‡ `IntentRouter` åˆ†å‘ç»™ç‰¹å®šçš„ Agentã€‚
    - **Muse**: ç”Ÿæˆå¤§çº² (`brainstorm`) æˆ–æ­£æ–‡ (`draft`)ã€‚
    - **Guard**: æ£€æŸ¥ç”Ÿæˆå†…å®¹çš„é€»è¾‘ (`critique`) æˆ–æ–°è§„åˆ’çš„å†²çª (`check_future_plan_contradiction`)ã€‚
    - **Stylist**: æ¶¦è‰²æ­£æ–‡ (`polish`)ã€‚
    - **WorldBuilder**: ç”Ÿæˆæˆ–ä¼˜åŒ–è®¾å®š (`create_settings`)ã€‚
    - **Critic**: ç‚¹è¯„å‰§æƒ… (`critique`)ã€‚

4.  **è®°å¿†æ›´æ–° (Memory Update)**:
    - æ–°å†…å®¹ç”Ÿæˆåï¼Œ`Archivist` åˆ†ææ–‡æœ¬ï¼Œæå–â€œè§’è‰²çŠ¶æ€å˜æ›´â€ã€â€œå‰§æƒ…æ‘˜è¦â€ã€â€œæ–°è®¾å®šâ€ç­‰ä¿¡æ¯ (`propose_updates`)ã€‚
    - ç³»ç»Ÿç”Ÿæˆä¸€ä¸ªâ€œè®°å¿†æ›´æ–°ææ¡ˆâ€ (Proposal)ã€‚
    - ç”¨æˆ·ç¡®è®¤åï¼Œ`ContextManager` å°†æ›´æ–°å†™å…¥ `data/novel.db`ï¼ˆä»¥åŠåŒåº“å…³ç³»è¡¨ï¼‰ï¼Œå®Œæˆè®°å¿†é—­ç¯ã€‚

## 4. æ™ºèƒ½ä½“ (Agents) èŒè´£è¯¦è§£

| Agent | æ–‡ä»¶ | èŒè´£æè¿° | æ ¸å¿ƒæ–¹æ³• |
| :--- | :--- | :--- | :--- |
| **Muse** | `muse.py` | **ä¸»ç¬”/ç­–åˆ’**ã€‚è´Ÿè´£å‰§æƒ…æ¨æ¼”ã€å¤§çº²ç”Ÿæˆã€æ­£æ–‡æ’°å†™ã€‚å…·å¤‡â€œçˆ½æ–‡â€é€»è¾‘ï¼Œä¼˜å…ˆè€ƒè™‘æœªæ¥è§„åˆ’ã€‚æä¾›æœ¬åœ°å…œåº•é€»è¾‘ (`brainstorm_local`) ä»¥é˜² API æ•…éšœã€‚ | `brainstorm`, `draft`, `rewrite` |
| **Stylist** | `stylist.py` | **æ¶¦è‰²**ã€‚è´Ÿè´£å°†æœ´ç´ çš„æ–‡æœ¬è½¬åŒ–ä¸ºç°ä»£ç„å¹»é£æ ¼ï¼Œä¼˜åŒ–æ‰“æ–—æå†™å’Œç¯å¢ƒæ¸²æŸ“ã€‚ | `polish` |
| **Guard** | `guard.py` | **è´¨æ£€/é—®ç­”**ã€‚æ£€æŸ¥é€»è¾‘æ¼æ´ã€æˆ˜åŠ›å´©åã€è®¾å®šå†²çªã€‚ä¹Ÿè´Ÿè´£åŸºäºè®°å¿†åº“å›ç­”ç”¨æˆ·æé—®ã€‚ | `critique`, `check_future_plan_contradiction`, `answer_question` |
| **Archivist** | `archivist.py` | **è®°å½•**ã€‚ä»éç»“æ„åŒ–æ–‡æœ¬ä¸­æå–ç»“æ„åŒ–æ•°æ®ï¼ˆJSONï¼‰ã€‚è´Ÿè´£ç»´æŠ¤è®°å¿†åº“çš„æ•´æ´å’Œæ›´æ–°ã€‚ | `propose_updates`, `check_future_plans_coverage` |
| **WorldBuilder** | `world_builder.py` | **æ¶æ„**ã€‚è´Ÿè´£ä¸–ç•Œè§‚è®¾å®šçš„ç”Ÿæˆä¸è¯„ä¼°ã€‚ | `create_settings` |
| **Critic** | `critic.py` | **ç‚¹è¯„**ã€‚è´Ÿè´£çˆ½ç‚¹/æ¯’ç‚¹ç‚¹è¯„ã€‚ | `critique` |
| **Router** | `intent_router.py` | **è°ƒåº¦**ã€‚åˆ†æç”¨æˆ·è¾“å…¥çš„è‡ªç„¶è¯­è¨€ï¼Œåˆ¤æ–­æ„å›¾ï¼ˆåˆ›ä½œã€æé—®ã€ä¿®æ­£ç­‰ï¼‰ã€‚ | `route` |

## 4.5 å¯è§‚å¯Ÿæ€§ï¼ˆMetrics / Logsï¼‰

é¡¹ç›®å½“å‰é‡‡ç”¨ Prometheus æŒ‡æ ‡ + ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSON è¡Œï¼‰ï¼Œç”¨äºåœ¨ Grafana ä¸Šè§‚å¯Ÿ LLM è°ƒç”¨ã€æ£€ç´¢ç“¶é¢ˆã€é‡è¯•å‹åŠ›ä¸å…³é”®é“¾è·¯è€—æ—¶ã€‚å½“å‰æœªå¼•å…¥ tracingã€‚

### 4.5.1 Prometheus Metrics

#### å¯¼å‡ºåœ°å€

é»˜è®¤å¯åŠ¨ï¼š

- `http://127.0.0.1:9108/metrics`

ç«¯å£å ç”¨æ—¶ä¼šè‡ªåŠ¨å°è¯• `9108~9139` çš„ä¸‹ä¸€ä¸ªå¯ç”¨ç«¯å£ï¼Œå¹¶åœ¨ `data/logs/app.log` å†™å…¥ `metrics_started`ï¼ˆå«æœ€ç»ˆç«¯å£ï¼‰ã€‚

ç¯å¢ƒå˜é‡ï¼š

- `FNA_METRICS=1|0`ï¼šæ˜¯å¦å¯ç”¨ metricsï¼ˆé»˜è®¤ `1`ï¼‰
- `FNA_METRICS_HOST`ï¼šç»‘å®šåœ°å€ï¼ˆé»˜è®¤ `127.0.0.1`ï¼›å®¹å™¨åŒ–/è¿œç¨‹æŠ“å–æ—¶å»ºè®® `0.0.0.0`ï¼‰
- `FNA_METRICS_PORT`ï¼šç«¯å£ï¼ˆé»˜è®¤ `9108`ï¼‰

å¯åŠ¨å…¥å£ï¼š

- åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ `init_observability()`ï¼š[app.py](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/app.py#L22-L31)

#### æŒ‡æ ‡åˆ—è¡¨

LLM è°ƒç”¨ï¼š

- `fna_llm_requests_total{agent,model,provider,status}`ï¼šLLM è¯·æ±‚æ¬¡æ•°
- `fna_llm_latency_seconds_bucket{agent,model,provider,status}`ï¼šLLM è¯·æ±‚è€—æ—¶ç›´æ–¹å›¾
- `fna_llm_tokens_total{agent,model,provider,kind}`ï¼štokens è®¡æ•°ï¼ˆ`kind=prompt|completion|total`ï¼‰

åŸ‹ç‚¹ä½ç½®ï¼š

- [base_agent.py](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/agents/base_agent.py)

æ£€ç´¢ï¼ˆRAG Retrievalï¼‰ï¼š

- `fna_retrieval_requests_total{op,status}`ï¼šæ£€ç´¢è°ƒç”¨æ¬¡æ•°
- `fna_retrieval_latency_seconds_bucket{op,status}`ï¼šæ£€ç´¢è€—æ—¶ç›´æ–¹å›¾

å½“å‰ `op`ï¼š

- `search_hybrid`
- `search_vectors`
- `search_chapters_fts`

å¸¸è§ `status`ï¼š

- `success`ï¼šæˆåŠŸè¿”å›
- `error`ï¼šå¼‚å¸¸
- `disabled`ï¼šå‘é‡æ£€ç´¢è¢«å…³é—­ï¼ˆ`DISABLE_VECTOR=1`ï¼‰
- `empty`ï¼šç©º query

åŸ‹ç‚¹ä½ç½®ï¼š

- [memory_manager.py](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/utils/memory_manager.py)

RAG é£é™©å¤„ç½®ï¼ˆRAG Guardï¼‰ï¼š

- `fna_rag_snippets_total{source_type,trust_tier,risk,action}`ï¼šæŒ‰é£é™©å¤„ç½®ç»Ÿè®¡å‘½ä¸­ç‰‡æ®µæ•°
- `fna_errors_total{component,kind}`ï¼šRAG Guard JSON è§£æå¤±è´¥ç­‰é LLM é”™è¯¯

Fact Guard é˜»æ–­ï¼š

- `fna_fact_guard_blocks_total{kind}`ï¼šFact Guard é˜»æ­¢å†™å…¥æ¬¡æ•°

èµ„æºæŠ¤æ ï¼ˆé‡è¯•/æœ€ç»ˆå¤±è´¥ï¼‰ï¼š

- `fna_agent_call_retries_total{op}`ï¼šé‡è¯•æ¬¡æ•°ï¼ˆæŒ‰â€œè¢«åŒ…è£…çš„è°ƒç”¨â€èšåˆï¼‰
- `fna_agent_call_failures_total{op}`ï¼šæœ€ç»ˆå¤±è´¥æ¬¡æ•°ï¼ˆè€—å°½ max_attemptsï¼‰

åŸ‹ç‚¹ä½ç½®ï¼š

- [_agent_call_with_limit](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/app.py#L2088-L2110)

å…³é”®ç”¨æˆ·é“¾è·¯è€—æ—¶ï¼ˆâ€œAPI ç»´åº¦â€çœ‹æ¿ï¼‰ï¼š

- `fna_flow_latency_seconds_bucket{flow,status}`ï¼šå…³é”®é“¾è·¯æ€»è€—æ—¶ç›´æ–¹å›¾

å½“å‰ `flow`ï¼š

- `brainstorm`
- `draft`
- `critique`
- `apply_memory_update`

#### Grafana å¸¸ç”¨ PromQL ç¤ºä¾‹

- LLM è€—æ—¶ P95ï¼š
  - `histogram_quantile(0.95, sum by(le,agent,model) (rate(fna_llm_latency_seconds_bucket[5m])))`
- LLM é”™è¯¯ç‡ï¼š
  - `sum(rate(fna_llm_requests_total{status="error"}[5m])) / sum(rate(fna_llm_requests_total[5m]))`
- æ£€ç´¢è€—æ—¶ P95ï¼š
  - `histogram_quantile(0.95, sum by(le,op) (rate(fna_retrieval_latency_seconds_bucket[5m])))`
- é‡è¯•çƒ­æ¦œï¼š
  - `topk(10, sum by(op) (increase(fna_agent_call_retries_total[15m])))`
- å…³é”®é“¾è·¯è€—æ—¶ P95ï¼š
  - `histogram_quantile(0.95, sum by(le,flow) (rate(fna_flow_latency_seconds_bucket[5m])))`

### 4.5.2 ç»“æ„åŒ–æ—¥å¿—ï¼ˆStructured Logsï¼‰

è¾“å‡ºä½ç½®ä¸æ ¼å¼ï¼š

- è¾“å‡ºæ–‡ä»¶ï¼š`data/logs/app.log`
- æ ¼å¼ï¼šæ¯è¡Œä¸€æ¡ JSONï¼ˆä¾¿äº Loki/Vector/Fluent Bit æ”¶é›†ï¼‰
- çº§åˆ«ï¼š`FNA_LOG_LEVEL`ï¼ˆé»˜è®¤ `INFO`ï¼‰

å…³é”®äº‹ä»¶ï¼š

- `app_started`ï¼šåº”ç”¨å¯åŠ¨
- `metrics_started`ï¼šmetrics server å¯åŠ¨æˆåŠŸ
- `metrics_disabled` / `metrics_unavailable`ï¼šmetrics è¢«å…³é—­æˆ–ä¾èµ–ä¸å¯ç”¨
- `llm_call`ï¼šæ¯æ¬¡æˆåŠŸ LLM è°ƒç”¨ï¼ˆåŒ…å« agent/model/base_url/latency_msï¼›å¦‚å¯å¾—åˆ™å« tokenï¼›èµ° Cloudflare AI Gateway æ—¶è¿˜ä¼šåŒ…å« cfAigEventId/cfAigLogId ç­‰ï¼‰
- `llm_error`ï¼šLLM è°ƒç”¨å¼‚å¸¸ï¼ˆä¸åŒ…å«å¯†é’¥ï¼‰
- `rag_audit`ï¼šRAG é£é™©å¤„ç½®å®¡è®¡ï¼ˆç»Ÿè®¡ kept/redacted/droppedï¼‰
- `fact_guard_block`ï¼šFact Guard é˜»æ–­å†™å…¥

å®ç°ä½ç½®ï¼š

- [observability.py](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/utils/observability.py)

#### åœæ­¢æœ¬åœ°æœåŠ¡ï¼ˆæ¸…ç†æ®‹ç•™ç«¯å£ï¼‰

Streamlit çƒ­æ›´æ–°å¯èƒ½å¯¼è‡´æ—§è¿›ç¨‹æœªå®Œå…¨é€€å‡ºï¼Œè¡¨ç°ä¸ºå¤šä¸ª metrics ç«¯å£åŒæ—¶å¯è®¿é—®ã€‚å¯ä½¿ç”¨ï¼š

- `bash scripts/stop_all_services.sh`

### 4.5.3 å¸¸è§é—®é¢˜

ä¸ºä»€ä¹ˆä¼šå‡ºç°å¤šæ¡ `app_started`ï¼Ÿ

- Streamlit åœ¨çƒ­é‡è½½/å¤šè¿›ç¨‹æ¨¡å¼ä¸‹ä¼šäº§ç”Ÿå¤šä¸ªè¿›ç¨‹æˆ–é‡å¯ï¼Œå› æ­¤å¯åŠ¨æ—¥å¿—å¯èƒ½å¤šæ¬¡å‡ºç°ï¼›metrics ä¹Ÿå¯èƒ½éšè¿›ç¨‹é‡å¯è€Œåˆ‡æ¢

ä¸ºä»€ä¹ˆæœ¬æœºè®¿é—®ä¸åˆ° `:9108/metrics`ï¼Ÿ

- æ£€æŸ¥ `FNA_METRICS` æ˜¯å¦ä¸º `1`
- æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼ˆæ¢ `FNA_METRICS_PORT`ï¼‰
- æ£€æŸ¥ç»‘å®šåœ°å€æ˜¯å¦åˆé€‚ï¼šæœ¬åœ°é€šå¸¸ç”¨ `127.0.0.1`ï¼Œå®¹å™¨/è¿œç«¯æŠ“å–éœ€ `0.0.0.0`

## 5. æ•°æ®å­˜å‚¨ä¸è®°å¿†ç³»ç»Ÿ (Data Architecture)

è‡ª 2026-01-25 èµ·ï¼Œç³»ç»Ÿå·²ä»æ–‡ä»¶å­˜å‚¨è¿ç§»è‡³ **SQLite æ•°æ®åº“**ï¼Œå¹¶é€æ­¥å¼•å…¥â€œå…³ç³»å‹ç»“æ„æ•°æ®åº“â€ä»¥æ”¯æŒæ›´å¤æ‚çš„æ£€ç´¢ä¸è”åŠ¨ã€‚

### 5.1 æ ¸å¿ƒæ•°æ® (`data/novel.db`)
æ‰€æœ‰çš„åˆ›ä½œå†…å®¹å‡å­˜å‚¨åœ¨æ­¤ SQLite æ•°æ®åº“ä¸­ï¼š
*   **`chapters` è¡¨**: ç« èŠ‚å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€æ—¶é—´ã€ç¨³å®š IDï¼‰ã€‚
    * `ulid`ï¼šç¨³å®šå¯è¿ç§»çš„å”¯ä¸€æ ‡è¯†ï¼ˆä¸ºå¤šç«¯ç¦»çº¿åˆå¹¶ä¸ç´¢å¼•å¯¹é½æ‰“åº•ï¼‰ã€‚
    * `content_key`ï¼šç« èŠ‚æ­£æ–‡åœ¨å¯¹è±¡å­˜å‚¨ä¸­çš„ keyï¼ˆä¸º D1/R2 ç­‰â€œæ­£æ–‡æ‹†åˆ†â€åšå‡†å¤‡ï¼‰ã€‚
    * `mentioned_character_ids`ï¼šæœ¬ç« â€œæåŠè§’è‰²â€åˆ—è¡¨ï¼ˆJSON å­—ç¬¦ä¸²ï¼Œå­˜è§’è‰²è¡¨ ID æ•°ç»„ï¼‰ã€‚ç”¨äºç« èŠ‚ç­›é€‰ä¸ UI å±•ç¤ºï¼ˆåªæ˜¾ç¤ºæœ¬ç« ç›¸å…³è§’è‰²ï¼Œè€Œéå…¨è§’è‰²åº“ï¼‰ã€‚
    * `primary_character_id`ï¼šç« èŠ‚ä¸»è§†è§’è§’è‰²ï¼ˆå·²åœç”¨/å¼ƒç”¨ï¼šå¯¹åº” UI ä¸æ£€ç´¢è¿‡æ»¤å·²ç§»é™¤ï¼›å­—æ®µæš‚ä¿ç•™ç”¨äºå…¼å®¹æ—§åº“ä¸æœªæ¥å¯èƒ½çš„é‡æ–°è®¾è®¡ï¼‰ã€‚
*   **å¯¹è±¡å­˜å‚¨ï¼ˆæœ¬åœ°ï¼‰**ï¼šç« èŠ‚æ­£æ–‡é»˜è®¤å†™å…¥ `data/blob_store/chapters/{chapter_ulid}.txt`ï¼ˆkey å½¢å¦‚ `chapters/{chapter_ulid}.txt`ï¼‰ï¼Œæ•°æ®åº“é€šå¸¸åªä¿å­˜ `content_key`ï¼Œä¸å†å†—ä½™ä¿å­˜æ•´æ®µæ­£æ–‡åˆ° `chapters.content`ï¼ˆä»…åœ¨å¯¹è±¡å†™å…¥å¤±è´¥æ—¶æ‰å¯èƒ½å›é€€å†™å…¥ DB ä»¥é˜²ä¸¢å¤±ï¼‰ã€‚
*   **`drafts` è¡¨**: å†™ä½œè‰ç¨¿ã€‚
*   **`kv_store` è¡¨**: å­˜å‚¨éç»“æ„åŒ–è®°å¿†æ•°æ®ï¼ˆKey-Value å½¢å¼ï¼‰ã€‚
    *   `plot_summaries`: å‰§æƒ…æ‘˜è¦ (JSON)
    *   `character_db`: è§’è‰²æ•°æ®åº“ (JSON)
    *   `map_db`: åœ°å›¾æ•°æ® (JSON)
    *   `world_settings`: ä¸–ç•Œè§‚è®¾å®š (Text)
    *   `future_plans`: æœªæ¥è§„åˆ’ (JSON)
    *   `style_guide.md`: é£æ ¼æŒ‡å—ï¼ˆMarkdownï¼‰
    *   `device_ulid`: å½“å‰è®¾å¤‡æ ‡è¯†ï¼ˆä¸º op-log åŒæ­¥é¢„ç•™ï¼‰

*   **`chapters_fts` (FTS5)**: ç« èŠ‚å…¨æ–‡æ£€ç´¢è™šè¡¨ï¼ˆtitle/contentï¼‰ï¼Œå½“å‰ç”± `save_chapter()` è¿›è¡Œâ€œæ‰‹åŠ¨æ›´æ–°â€ï¼ˆè§¦å‘å™¨å·²ç§»é™¤ï¼‰ï¼Œä»¥é€‚é…â€œæ­£æ–‡å¯èƒ½æ‹†åˆ†åˆ° blob storeâ€çš„æ¶æ„ã€‚
*   **`oplog` è¡¨**: æ“ä½œæ—¥å¿—ï¼ˆéª¨æ¶ï¼‰ï¼Œè®°å½•ç« èŠ‚ upsert ä¸ KV setï¼Œä¾¿äºæœªæ¥åšâ€œå¤šç«¯ç¦»çº¿ç¼–è¾‘ååˆå¹¶â€ã€‚

### 5.2 å…³ç³»å‹ç»“æ„è¡¨ï¼ˆå®éªŒï¼Œè½åœ¨ `data/novel.db` å†…ï¼‰
åœ¨ä¿ç•™ `kv_store` çš„åŒæ—¶ï¼Œé¡¹ç›®å¼•å…¥å…³ç³»å‹ç»“æ„è¡¨ï¼ŒæŠŠéƒ¨åˆ† KV ç»“æ„â€œæ‹†è¡¨â€æˆå¯æŸ¥è¯¢ã€å¯å…³è”çš„å®ä½“ï¼ˆè§’è‰²/åŠ¿åŠ›/åœ°ç‚¹/æ³•å®/åŠŸæ³•ç­‰ï¼‰ï¼Œä»¥ä¾¿ï¼š
* æ›´å¿«çš„å®ä½“æ£€ç´¢ä¸èšåˆï¼ˆä¾‹å¦‚ï¼šæŸ¥æŸè§’è‰²åä¸‹æ‰€æœ‰æ³•å®ä¸åŠŸæ³•ï¼‰
* æ›´å¯é çš„å®ä½“å…³ç³»ç»´æŠ¤ï¼ˆä¾‹å¦‚ï¼šè§’è‰²-åŠ¿åŠ›ã€è§’è‰²-åŠŸæ³• ç­‰å¤šå¯¹å¤šå…³ç³»ï¼‰

å½“å‰çŠ¶æ€ï¼š
* Streamlit ä¸»ç¨‹åºä»ä»¥ `data/novel.db` ä¸ºâ€œäº‹å®æ¥æºï¼ˆSource of Truthï¼‰â€
* å…³ç³»è¡¨ä¸ KV åŒåº“ï¼ˆå•ä¸€æ•°æ®åº“æ–‡ä»¶ï¼‰ï¼Œé™ä½è·¨åº“ä¸€è‡´æ€§ä¸éƒ¨ç½²å¤æ‚åº¦

ç›¸å…³å®ç°ï¼š
* å…³ç³»å‹æ¨¡å‹ä¸ DB ç®¡ç†ï¼š[db_manager.py](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/utils/db_manager.py)
* KV -> å…³ç³»å‹è¿ç§»è„šæœ¬ï¼š[migrate_to_sql.py](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/scripts/migrate_to_sql.py)

è¿ç§»å»ºè®®ï¼ˆæœ¬æœº/æ ‘è“æ´¾ä¸€è‡´ï¼‰ï¼š
1. å…ˆå¤‡ä»½ `data/novel.db`
2. æ‰§è¡Œè¿ç§»è„šæœ¬ï¼Œåœ¨ `data/novel.db` å†…åˆ›å»º/æ›´æ–°å…³ç³»è¡¨

### 5.2 ç´¢å¼•å±‚ï¼ˆå¯é‡å»ºï¼‰
ç³»ç»ŸåšæŒ `data/novel.db` ä¸ºäº‹å®æ¥æºï¼›æ£€ç´¢ç´¢å¼•å…è®¸æŸå/å†²çªåé‡å»ºï¼š
* **å‘é‡ç´¢å¼•**ï¼š`data/vector_db/`ï¼ˆChromaDB æœ¬åœ°æŒä¹…åŒ–ï¼‰ã€‚
  - ç”±ç« èŠ‚è¯­ä¹‰åˆ†å— + embedding æ„å»º
  - é‡å»ºè„šæœ¬ï¼š`scripts/init_vector_db.py`

### 5.3 é…ç½®æ–‡ä»¶ (Files)
ä¸ºäº†å®‰å…¨å’Œç®¡ç†æ–¹ä¾¿ï¼Œéƒ¨åˆ†æ•°æ®ä»ä¿ç•™ä¸ºæ–‡ä»¶ï¼š
*   **`data/config/model_profiles.json`**: æ¨¡å‹ API å¯†é’¥é…ç½®ã€‚
    *   **ç»“æ„å˜æ›´ (v0.2.1)**: æ–°å¢ `llm_routing` å­—æ®µï¼Œæ”¯æŒæŒ‰ Agent åˆ†é…æ¨¡å‹ã€‚
    *   `mode`: "unified" (ç»Ÿä¸€) æˆ– "per_agent" (åˆ†æµ)ã€‚
    *   `agent_profile_ids`: `{ "Muse": "id1", "Guard": "id2" ... }`ã€‚
*   **`data/config/storage_sync.json`**: æ•°æ®å­˜å‚¨ä¸åŒæ­¥é…ç½®ï¼ˆå½“å‰ç”¨äºâ€œäº‘ç«¯å¯¹è±¡å­˜å‚¨ï¼ˆç« èŠ‚æ­£æ–‡ï¼‰â€ï¼‰ã€‚
    * `object_store.enabled`: æ˜¯å¦å¯ç”¨äº‘ç«¯å¯¹è±¡å­˜å‚¨ï¼ˆR2/S3ï¼‰ã€‚
    * `object_store.provider`: `r2|s3` ç­‰ï¼ˆS3 å…¼å®¹åè®®ï¼‰ã€‚
    * `object_store.bucket/endpoint/region/access_key_id/secret_access_key/prefix`: è¿æ¥å‚æ•°ã€‚
    * `object_store.read_prefer_local / write_mirror_local`: æœ¬åœ°ç¼“å­˜ç­–ç•¥ï¼ˆæœ¬åœ°ç›®å½•ä»ä¸º `data/blob_store/`ï¼‰ã€‚
    * `object_store.strict_write_remote`: ä¸¥æ ¼æ¨¡å¼ï¼ˆäº‘ç«¯å¤±è´¥å³æŠ¥é”™ï¼‰vs éä¸¥æ ¼æ¨¡å¼ï¼ˆå¯é™çº§ + è‡ªåŠ¨è¡¥ä¼ ï¼‰ã€‚
*   **`data/logs/usage_stats.json`**: Token ç”¨é‡ç»Ÿè®¡æ—¥å¿—ã€‚

### 5.4 å¤šç«¯åŒæ­¥ï¼ˆç°çŠ¶ä¸è¾¹ç•Œï¼‰
* `data/novel.db` æ˜¯å•æœºä¸€è‡´æ€§ä¸â€œå•ä¸€äº‹å®æ¥æºâ€çš„åŸºç¡€ï¼Œä½†**åŒæ­¥ db æ–‡ä»¶ä¸ç­‰äºè§£å†³å¤šç«¯å¹¶å‘åˆå¹¶**ã€‚
* å½“å‰å®ç°ä»…æä¾› `oplog` çš„éª¨æ¶ï¼Œå°šæœªå®ç° op-log çš„è·¨ç«¯å›æ”¾ä¸å†²çªè§£å†³ï¼›åœ¨å¤šç«¯åœºæ™¯ä¸‹è¯·é¿å…ä¾èµ–â€œç½‘ç›˜åŒæ­¥ db æ–‡ä»¶â€æ¥åˆå¹¶ä¿®æ”¹ã€‚

### 5.5 æ¶æ„æ¼”è¿›è¿‡æ¸¡ï¼šå‰åç«¯åˆ†ç¦» (Backend Decoupling)
åœ¨è¿ˆå‘äº‘åŸç”Ÿæ¶æ„ä¹‹å‰ï¼Œå»ºè®®å…ˆè¿›è¡Œ**åº”ç”¨å±‚çš„è§£è€¦**ã€‚

**å½“å‰çŠ¶æ€ (Monolith)**:
`app.py` (Streamlit) åŒæ—¶è´Ÿè´£ UI æ¸²æŸ“ã€ä¸šåŠ¡é€»è¾‘è°ƒåº¦ (Agents) å’Œæ•°æ®åº“è¯»å†™ (Storage)ã€‚

**ç›®æ ‡çŠ¶æ€ (Decoupled)**:
1.  **åç«¯ (API å±‚)**: ä½¿ç”¨ **FastAPI** å°è£…æ ¸å¿ƒé€»è¾‘ã€‚
    *   æä¾› RESTful æ¥å£ï¼š`POST /api/brainstorm`, `GET /api/chapters`, `POST /api/memory/update`.
    *   ç‹¬ç«‹éƒ¨ç½²ï¼Œä¸ä¾èµ–ç•Œé¢åº“ã€‚
2.  **å‰ç«¯ (UI å±‚)**: Streamlit (æˆ–æœªæ¥çš„ React/Flutter) ä»…ä½œä¸ºå®¢æˆ·ç«¯ï¼Œé€šè¿‡ HTTP è¯·æ±‚ä¸åç«¯äº¤äº’ã€‚

### 5.6 æœªæ¥æ¶æ„è§„åˆ’ (Cloud Native Migration)
éšç€å°è¯´ç¯‡å¹…å¢é•¿ï¼Œå»ºè®®é‡‡ç”¨ **â€œæ•°æ®åº“ + å¯¹è±¡å­˜å‚¨â€** çš„æ··åˆæ¶æ„ã€‚

| æ•°æ®ç±»å‹ | æ¨èå­˜å‚¨ä½ç½® | ç†ç”± |
| :--- | :--- | :--- |
| **å…ƒæ•°æ®/ç»“æ„åŒ–æ•°æ®** | **æ•°æ®åº“ (D1/SQLite)** | ç« èŠ‚åˆ—è¡¨ã€è§’è‰²åº“ã€å‰§æƒ…æ‘˜è¦éœ€è¦é«˜é¢‘è¯»å–å’Œå¤æ‚æŸ¥è¯¢ã€‚ |
| **å¤§æ–‡æœ¬/å¤šåª’ä½“** | **å¯¹è±¡å­˜å‚¨ (R2/S3)** | å°è¯´ç« èŠ‚æ­£æ–‡ã€å†™ä½œè‰ç¨¿ã€å›¾ç‰‡ç´ æä½“ç§¯å¤§ä¸”è¯»å†™ç®€å•ï¼Œåˆ†ç¦»å­˜å‚¨å¯é™ä½æ•°æ®åº“è´Ÿè½½ã€‚ |

**è¿ç§»ç­–ç•¥**:
1.  **æ­£æ–‡åˆ†ç¦»**: æ•°æ®åº“ `chapters` è¡¨ä»…å­˜ `id` å’Œ `s3_key`ï¼Œæ­£æ–‡å†…å®¹å­˜å…¥ R2ã€‚
2.  **æ‘˜è¦ä¿ç•™**: å‰§æƒ…æ‘˜è¦ (`plot_summaries`) ç»§ç»­ç•™åœ¨æ•°æ®åº“ï¼Œä»¥ä¾¿ Agent å¿«é€Ÿæ£€ç´¢ä¸Šä¸‹æ–‡ã€‚

#### 5.6.1 å·²è½åœ°ï¼šäº‘ç«¯å¯¹è±¡å­˜å‚¨ï¼ˆR2ï¼ŒS3 å…¼å®¹ï¼‰
é¡¹ç›®å·²æ”¯æŒé€šè¿‡ **S3 å…¼å®¹ API** å°†ç« èŠ‚æ­£æ–‡å†™å…¥ Cloudflare R2ï¼ˆä¸è¦æ±‚å‰åç«¯åˆ†ç¦»ï¼Œä¸è¦æ±‚ Workerï¼‰ï¼š
* é…ç½®å…¥å£ï¼š`ğŸ”§ é€šç”¨è®¾ç½® â†’ ğŸ—„ï¸ æ•°æ®å­˜å‚¨ä¸åŒæ­¥ â†’ äº‘ç«¯å¯¹è±¡å­˜å‚¨ï¼ˆç« èŠ‚æ­£æ–‡ï¼‰`
* æœ¬åœ°ç¼“å­˜ç›®å½•ï¼š`data/blob_store/chapters/`ï¼ˆå¯é€‰è¯»æœ¬åœ°ä¼˜å…ˆã€å†™å…¥é•œåƒæœ¬åœ°ï¼‰
* è‡ªåŠ¨è¡¥ä¼ é˜Ÿåˆ—ï¼ˆéä¸¥æ ¼æ¨¡å¼ï¼‰ï¼š`data/config/object_store_pending_puts.json`
* è¿ç§»å·²æœ‰æ­£æ–‡ï¼šåœ¨åŒä¸€è®¾ç½®åŒºæä¾›â€œä¸€é”®è¿ç§»â€æŒ‰é’®ï¼›ä¹Ÿå¯ä½¿ç”¨è„šæœ¬ `scripts/migrate_local_chapters_to_object_store.py`

### 5.7 æœ¬åœ°å¼€å‘ç­–ç•¥ (Local Dev Strategy)
é’ˆå¯¹æœªæ¥å¼•å…¥çš„å¯¹è±¡å­˜å‚¨ (Object Storage)ï¼Œæ¨èä»¥ä¸‹ä¸¤ç§æœ¬åœ°å¼€å‘æ–¹æ¡ˆï¼š

1.  **æ–‡ä»¶ç³»ç»Ÿæ¨¡æ‹Ÿ (æ¨è)**:
    *   **åŸç†**: å®ç°ä¸€ä¸ª `FileBlobStorage` é€‚é…å™¨ï¼Œåœ¨æœ¬åœ°å°†â€œå¯¹è±¡â€å­˜ä¸º `data/blobs/` ä¸‹çš„æ™®é€šæ–‡ä»¶ã€‚
    *   **ä¼˜åŠ¿**: é›¶ä¾èµ–ï¼Œæ— éœ€å®‰è£… Docker æˆ–é¢å¤–æœåŠ¡ï¼Œå¼€å‘ä½“éªŒæœ€æµç•…ã€‚
    *   **ç”Ÿäº§ç¯å¢ƒ**: ä¸Šçº¿æ—¶åˆ‡æ¢ä¸º `R2BlobStorage` å³å¯ã€‚

2.  **MinIO (Docker)**:
    *   **åŸç†**: åœ¨æœ¬åœ°è¿è¡Œ MinIO å®¹å™¨æ¨¡æ‹Ÿ S3 APIã€‚
    *   **å‘½ä»¤**: `docker run -p 9000:9000 minio/minio server /data`
    *   **ä¼˜åŠ¿**: API ä¸ AWS S3/Cloudflare R2 å®Œå…¨å…¼å®¹ï¼Œé€‚åˆæµ‹è¯• SDK é›†æˆã€‚

## 6. å…³é”®åŠŸèƒ½æ¨¡å—å®ç°

### 6.1 è‡ªåŠ¨æ¨æ¼”æ–°å‰§æƒ…
-   **è§¦å‘**: ç•Œé¢â€œè‡ªåŠ¨æ¨æ¼”æ–°å‰§æƒ…â€æŒ‰é’®ã€‚
-   **é€»è¾‘**: è°ƒç”¨ `Muse.brainstorm`ã€‚
-   **è¾“å…¥**: æœ€è¿‘ 10 ç« æ‘˜è¦ + ä¸–ç•Œè§‚ + ç›¸å…³è§’è‰² + æœ€è¿‘ 3 ç« åŸæ–‡ + æœªæ¥è§„åˆ’ã€‚
-   **è¾“å‡º**: 3 ä¸ªå‰§æƒ…åˆ†æ”¯é€‰é¡¹ã€‚
-   **å®¹é”™**: è‹¥ API å¤±è´¥ï¼Œæä¾› `brainstorm_local` æœ¬åœ°æ¨¡æ¿ç”Ÿæˆã€‚

### 6.2 è®°å¿†è‡ªåŠ¨æ›´æ–°
-   **è§¦å‘**: ç”¨æˆ·ç¡®è®¤å½’æ¡£ç« èŠ‚æˆ–ä¿å­˜è‰ç¨¿æ—¶ã€‚
-   **é€»è¾‘**: è°ƒç”¨ `Archivist.propose_updates` ç”Ÿæˆ JSON ææ¡ˆ -> ç”¨æˆ·ç¡®è®¤ -> `memory_manager` å†™å…¥æ–‡ä»¶ã€‚
-   **è‡ªåŠ¨åŒ–**: åŒæ—¶è°ƒç”¨ `Archivist.check_future_plans_coverage` æ£€æµ‹æ˜¯å¦å®Œæˆäº†æŸäº›æœªæ¥è§„åˆ’ï¼Œå¹¶æç¤ºç§»é™¤ã€‚

### 6.3 æœªæ¥å‘å±•è§„åˆ’
-   **åŠŸèƒ½**: ç‹¬ç«‹çš„è®°å¿†åº“ Tabã€‚
-   **é€»è¾‘**: æ·»åŠ æ—¶è°ƒç”¨ `Guard.check_future_plan_contradiction` ç¡®ä¿å­˜å…¥çš„è®¡åˆ’ä¸ä¸ç°æœ‰è®¾å®šå†²çªã€‚

### 6.4 æ¨¡å‹ç”¨é‡è¿½è¸ª
-   **åŠŸèƒ½**: è‡ªåŠ¨è®°å½•æ¯æ¬¡ API è°ƒç”¨çš„ Token æ¶ˆè€—ã€‚
-   **å®ç°**: `utils/usage_tracker.py` æ‹¦æˆª API è°ƒç”¨å¹¶å†™å…¥ `data/logs/usage_stats.json`ã€‚
-   **UI**: åœ¨â€œæ¨¡å‹ç®¡ç†â€ç•Œé¢æä¾›å¯è§†åŒ–çš„å†å²ç”¨é‡æŸ±çŠ¶å›¾ã€‚

### 6.5 UI äº¤äº’å¢å¼º
-   **å¤´è„‘é£æš´åˆ†æ”¯**: `Muse` ç”Ÿæˆçš„å‰§æƒ…åˆ†æ”¯ç°åœ¨ä»¥ç‹¬ç«‹æŒ‰é’®å‘ˆç°ï¼Œæ”¯æŒç‚¹é€‰æˆ–è¾“å…¥æ–°æŒ‡ä»¤ã€‚
-   **ç« èŠ‚å·ç¡®è®¤**: å½’æ¡£è®°å¿†æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ¨æ–­ç« èŠ‚å·ï¼ˆè‡ªåŠ¨é€’å¢ï¼‰ï¼Œä½†æä¾›æ˜¾å¼çš„æ•°å­—è¾“å…¥æ¡†ä¾›ç”¨æˆ·ç¡®è®¤æˆ–ä¿®æ”¹ï¼Œé¿å…é”™è¯¯å½’æ¡£ã€‚
-   **è§’è‰²å¿«é€Ÿèšç„¦å¼¹çª—**: â€œè§’è‰²çŠ¶æ€â€é¡µæ”¯æŒåœ¨å¼¹çª—å†…å¿«é€ŸæŸ¥çœ‹è§’è‰²è¯¦æƒ…ï¼Œå¹¶æ”¯æŒï¼š
    - å¼¹çª—å†…ç›¸å…³è·³è½¬æŒ‰é’®å¯ç‚¹å‡»å¹¶åˆ·æ–°å¼¹çª—å†…å®¹ï¼ˆåŸºäº `expanded_entity_name`ï¼‰
    - ä¾§è¾¹æ å¯æ“ä½œä¸”ç‚¹å‡»å¤–éƒ¨ä¸è‡ªåŠ¨å…³é—­ï¼ˆé€šè¿‡å¯¹é®ç½©ç‚¹å‡»è¿›è¡Œæ‹¦æˆªï¼‰
    - å¼¹çª—å¯æ‹–åŠ¨ï¼ˆä½¿ç”¨å³ä¸Šè§’æ‹–æ‹½çƒ­åŒºï¼‰

#### 6.5.1 è§’è‰²å¿«é€Ÿèšç„¦å¼¹çª—å®ç°è¦ç‚¹ï¼ˆ2026-01-27ï¼‰
è¯¥äº¤äº’å±äºâ€œUI + äº‹ä»¶å±‚ + SessionStateâ€ç»„åˆé—®é¢˜ï¼Œæ¨èæŠŠå®ç°é€»è¾‘æ‹†æˆä¸‰å—çœ‹ï¼š

### 6.6 ç« èŠ‚çº§â€œæåŠè§’è‰²â€ä¸è§’è‰²ç­›é€‰ï¼ˆ2026-01-28ï¼‰
ä¸ºäº†é¿å…â€œæ¯ç« ä¸‹æ‹‰æ¡†å¡æ»¡å…¨è§’è‰²åº“â€çš„å™ªéŸ³ï¼Œå¹¶æå‡å®šä½æ•ˆç‡ï¼Œé¡¹ç›®å¼•å…¥äº†ç« èŠ‚çº§çš„â€œæåŠè§’è‰²å­é›†â€ï¼š

* **ç”Ÿæˆæ—¶æœº**
  - å½’æ¡£/ä¿å­˜ç« èŠ‚æ­£æ–‡æ—¶ï¼šä»æ­£æ–‡é‡ŒåŒ¹é…è§’è‰²åº“å·²å­˜åœ¨çš„è§’è‰²åï¼Œå†™å…¥ `chapters.mentioned_character_ids`ã€‚
  - å…¼å®¹æ—§ç« èŠ‚ï¼šå½“è¯»å–æŸç« çš„ `mentioned_character_ids` ä¸ºç©ºæ—¶ï¼Œä¼šæ‡’åŠ è½½ä¸€æ¬¡ï¼ˆè¯»å–æ­£æ–‡ -> åŒ¹é… -> å†™å›ï¼‰ï¼Œä¹‹åæ— éœ€é‡å¤è®¡ç®—ã€‚
* **UI ä½¿ç”¨**
  - ç« èŠ‚åº“å³ä¾§å±•ç¤ºâ€œæœ¬ç« æåŠè§’è‰²â€ï¼ˆç”¨äºå¿«é€Ÿæ„ŸçŸ¥è¯¥ç« æ¶‰åŠäººç‰©ï¼‰ã€‚
  - ç« èŠ‚åº“å·¦ä¾§æä¾›â€œè§’è‰²ç­›é€‰â€ï¼ˆå¤šé€‰ï¼‰ï¼šåªæ˜¾ç¤ºæåˆ°æ‰€é€‰è§’è‰²çš„ç« èŠ‚ã€‚
* **è¾¹ç•Œä¸çº¦æŸ**
  - â€œæœ¬ç« æåŠè§’è‰²â€æ˜¯â€œè§’è‰²åº“å…¨é‡â€çš„å­é›†ï¼šåªä¼šä»è§’è‰²åº“å·²æœ‰è§’è‰²ä¸­åšåŒ¹é…ï¼Œä¸ä¼šå‡­ç©ºåˆ›å»ºæ–°è§’è‰²ã€‚
  - è‹¥æ­£æ–‡å‡ºç°æ–°äººç‰©ä½†è§’è‰²åº“å°šæœªæ”¶å½•ï¼Œéœ€å…ˆé€šè¿‡è®°å¿†æç‚¼æˆ–æ‰‹åŠ¨ç»´æŠ¤æŠŠè§’è‰²åŠ å…¥è§’è‰²åº“ï¼Œä¹‹åè¯¥äººç‰©æ‰ä¼šè¿›å…¥åŒ¹é…ç»“æœã€‚

### 6.7 å¼€å‘æœŸç¼“å­˜ç­–ç•¥ï¼ˆStreamlit Resource Cacheï¼‰
`ContextManager` é€šè¿‡ `st.cache_resource` ç¼“å­˜å¯æ˜¾è‘—å‡å°‘åˆå§‹åŒ–å¼€é”€ï¼Œä½†å¼€å‘æœŸå¯èƒ½å¯¼è‡´â€œä»£ç å·²æ”¹ã€å®ä¾‹ä»æ—§â€çš„é”™è§‰ã€‚

* å½“å‰å®ç°ä¼šå°† `app.py / utils/storage.py / utils/memory_manager.py` çš„ä¿®æ”¹æ—¶é—´æ‹¼æˆ cache keyï¼Œç¡®ä¿è¿™äº›æ ¸å¿ƒæ–‡ä»¶å˜æ›´åè‡ªåŠ¨é‡å»º `ContextManager`ï¼Œé¿å…çƒ­æ›´æ–°æœŸé—´è¯»åˆ°æ—§é€»è¾‘ã€‚

### 6.8 Embedding åç«¯ï¼ˆEMBEDDING_BACKENDï¼‰
å‘é‡ç´¢å¼•/å‘é‡æ£€ç´¢éœ€è¦æŠŠæ–‡æœ¬ç¼–ç ä¸ºå‘é‡ï¼ˆembeddingï¼‰ã€‚æœ¬é¡¹ç›®æ”¯æŒå¤šç§ embedding åç«¯ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ `EMBEDDING_BACKEND` é€‰æ‹©ã€‚

* **å¯é€‰å€¼**
  - `hf`ï¼šæœ¬åœ° HuggingFace + torchï¼ˆé»˜è®¤ï¼Œé€‚åˆ Mac/PCï¼›ä¸èµ°ç½‘ç»œï¼›CPU ä¸Šå¯ç”¨ä½†é€Ÿåº¦å–å†³äºæœºå™¨æ€§èƒ½ï¼‰ã€‚
  - `onnx`ï¼šæœ¬åœ° ONNX æ¨ç†ï¼ˆç”¨äºåœ¨éƒ¨åˆ†ç¯å¢ƒä¸­æå‡å…¼å®¹æ€§/ç¨³å®šæ€§ï¼‰ã€‚
  - `openai`ï¼šè°ƒç”¨ OpenAI Embeddings APIï¼ˆéœ€è¦è”ç½‘ä¸ OpenAI API Keyï¼›æŒ‰ç”¨é‡è®¡è´¹ï¼›åœ¨æ ‘è“æ´¾ç­‰ ARM ç¯å¢ƒé€šå¸¸æ›´ç¨³ï¼‰ã€‚
* **é»˜è®¤ç­–ç•¥**
  - è‹¥æœªè®¾ç½® `EMBEDDING_BACKEND`ï¼š
    - åœ¨æ ‘è“æ´¾ 64 ä½ï¼ˆLinux aarch64 ä¸”æ£€æµ‹åˆ° Raspberry Piï¼‰ä¸Šé»˜è®¤é€‰ `openai`ï¼›
    - å…¶ä»–ç¯å¢ƒé»˜è®¤é€‰ `hf`ã€‚
* **è´¹ç”¨ä¸èµ„æºæƒè¡¡**
  - `openai`ï¼šæœ‰è°ƒç”¨è´¹ç”¨ï¼Œä½†å¯¹è®¾å¤‡ç®—åŠ›è¦æ±‚ä½ã€å…¼å®¹æ€§é«˜ã€‚
  - `hf/onnx`ï¼šé€šå¸¸â€œå…è´¹â€ï¼ˆä¸äº§ç”Ÿ API è°ƒç”¨è´¹ï¼‰ï¼Œä½†å¯¹æœ¬åœ°ç¯å¢ƒä¾èµ–æ›´é‡ï¼›åœ¨ ARM ç¯å¢ƒå¯èƒ½å‡ºç°æ¨ç†åº“ä¸å…¼å®¹å¯¼è‡´å´©æºƒçš„æƒ…å†µã€‚
* **ä¸ `DISABLE_VECTOR` çš„å…³ç³»**
  - `DISABLE_VECTOR=1` ä¼šå½»åº•å…³é—­å‘é‡ç´¢å¼•ä¸å‘é‡æ£€ç´¢ï¼ˆåªä¿ç•™ FTS5 å…³é”®è¯æ£€ç´¢ï¼‰ï¼Œæ­¤æ—¶ `EMBEDDING_BACKEND` ä¸ç”Ÿæ•ˆã€‚

1. **å¼¹çª—å†…è·³è½¬ï¼ˆç›¸å…³é“¾æ¥ï¼‰**
   - å…¥å£å‡½æ•°ï¼š`render_links()` ä¼šæ‰«ææ–‡æœ¬ä¸­å‡ºç°çš„å…¶ä»–è§’è‰²åï¼Œå¹¶ç”Ÿæˆè·³è½¬æŒ‰é’®ã€‚
   - å…³é”®ç‚¹ï¼šä½¿ç”¨ `if st.button(...):` ç›´æ¥åˆ†æ”¯å¤„ç†ç‚¹å‡»å¹¶ `st.rerun()`ï¼Œé¿å…æŸäº›æƒ…å†µä¸‹ `on_click` å›è°ƒé“¾è·¯ä¸è§¦å‘ã€‚
   - å‚è€ƒå®ç°ï¼š[app.py:render_links](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/app.py#L2437-L2461)

2. **å¼¹çª—ä¸è‡ªåŠ¨å…³é—­ï¼Œä½†ä¾§è¾¹æ ä»å¯æ“ä½œ**
   - æ€è·¯ï¼šä¸å†åšå…¨å±€äº‹ä»¶æ‹¦æˆª/é‡æ´¾å‘ï¼Œè€Œæ˜¯åªåœ¨æ•è·é˜¶æ®µæ‹¦æˆªâ€œé®ç½©èƒŒæ™¯ç‚¹å‡»â€ï¼ˆ`e.target === wrapper`ï¼‰ã€‚
   - åŒæ—¶é€šè¿‡ z-index è®© sidebar é«˜äºé®ç½©å±‚ï¼Œé¿å… sidebar è¢«é®ç½©ç›–ä½ã€‚
   - å‚è€ƒå®ç°ï¼š[app.py:focus modal CSS/JS](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/app.py#L2475-L2510)

3. **å¼¹çª—æ‹–æ‹½ä¸ä½ç½®è®°å¿†**
   - æ€è·¯ï¼šä½¿ç”¨å¼¹çª—å³ä¸Šè§’çš„ä¸€ä¸ªé€æ˜æ‹–æ‹½çƒ­åŒºï¼ˆ32x32ï¼‰ï¼Œé¿å…è¦†ç›–å¼¹çª—å†…å®¹å¯¼è‡´æŒ‰é’®/é“¾æ¥ç‚¹å‡»å¤±æ•ˆã€‚
   - ä½ç½®è®°å¿†ï¼šå­˜å‚¨åœ¨ `localStorage`ï¼Œé”®ä¸º `fn_focus_dialog_pos`ã€‚
   - å‚è€ƒå®ç°ï¼š[app.py:drag handle](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/app.py#L2512-L2601)

### 6.6 è®¾å®šç”Ÿæˆä¸è¯„ä¼°
-   **åŠŸèƒ½**: `WorldBuilder` è´Ÿè´£æ ¹æ®ç°æœ‰å‰§æƒ…ç”Ÿæˆæ–°åŠ¿åŠ›ã€åŠŸæ³•æˆ–è¯„ä¼°è®¾å®šå†²çªã€‚

### 6.7 æ™ºèƒ½ä¹¦è¯„
-   **åŠŸèƒ½**: `Critic` è´Ÿè´£å¯¹ç”Ÿæˆçš„æ­£æ–‡è¿›è¡Œçˆ½ç‚¹åˆ†æå’Œæ¯’ç‚¹é¢„è­¦ã€‚

### 6.8 å‰§æƒ…æ¨æ¼”å¢å¼º
-   **åŠŸèƒ½**: è‡ªåŠ¨è¯†åˆ«æ¨æ¼”æ„å›¾ï¼Œå¹¶å…è®¸ä¸€é”®å°†æ¨æ¼”ç»“æœä¿å­˜ä¸ºâ€œåå°æ¨æµ‹â€æˆ–â€œæœªå¡«å‘â€ã€‚
-   **é€»è¾‘**: åœ¨ `Muse` çš„ `brainstorm` å“åº”ä¸­ï¼Œè‹¥æ£€æµ‹åˆ°â€œæ¨æ¼”/æ¨æµ‹â€ç­‰å…³é”®è¯ï¼Œè‡ªåŠ¨é™„åŠ å…ƒæ•°æ®ã€‚
-   **å­˜å‚¨**: åˆ†åˆ«å†™å…¥ `data/novel.db` çš„å…³ç³»è¡¨ `plot_inferences` ä¸ `unresolved_mysteries`ï¼ˆåŒåº“ï¼Œä¾¿äºä¸€è‡´æ€§ç»´æŠ¤ï¼‰ã€‚

### 6.9 æ£€ç´¢ä¸ RAGï¼ˆç´¢å¼•å±‚åŒå¼•æ“ï¼‰
- **FTS5ï¼ˆå…³é”®è¯ï¼‰**ï¼š`ContextManager.search_chapters_fts()`ï¼ˆè¿”å› snippet/bm25 æ’åºï¼‰
- **å‘é‡ï¼ˆè¯­ä¹‰ï¼‰**ï¼š`ContextManager.search_vectors()`ï¼ˆChromaDBï¼‰
- **Hybridï¼ˆå…³é”®è¯+è¯­ä¹‰ï¼‰**ï¼š`ContextManager.search_hybrid()`ï¼ˆFTS ä¸å‘é‡å¹¶è¡Œæ£€ç´¢ï¼Œå¹¶ç”¨ RRF æ€è·¯åšèåˆæ’åºï¼Œé¿å…å…³é”®è¯æœªå‘½ä¸­å¯¼è‡´è¯­ä¹‰å¬å›ä¸¢å¤±ï¼‰
- **UI**ï¼šä¸»çª—å£â€œğŸ§  æ£€ç´¢å¢å¼ºï¼ˆRAGï¼‰â€æŠ˜å åŒºï¼Œå¯åˆ‡æ¢ Hybrid/ä»…å…³é”®è¯/ä»…è¯­ä¹‰

### 6.10 ä¿®è¡Œç­‰çº§é€»è¾‘
- **é€»è¾‘**: `app.py` ä¸­çš„ `_infer_cultivation_rank` å‡½æ•°è´Ÿè´£ä»â€œå¢ƒç•Œâ€æè¿°æ¨æ–­æ•°å€¼ç­‰çº§ã€‚
- **è§„åˆ™**:
  - åŸºç¡€åˆ†å€¼ï¼šå‡¡äºº(5), å‡æ°”(10), ç­‘åŸº(20), é‡‘ä¸¹(30), å…ƒå©´(40), åŒ–ç¥(50), åŒ–ç¥ä»¥ä¸Š(60)ã€‚
  - å°å¢ƒç•Œåç§»ï¼šåˆæœŸ/å‰æœŸ(+3), ä¸­æœŸ(+6), åæœŸ(+9), åœ†æ»¡/å·…å³°(+10)ã€‚
  - å±‚æ•°åç§»ï¼š1-3å±‚(+3), 4-6å±‚(+6), 7-9å±‚(+9)ã€‚
  - å–å°å¢ƒç•Œä¸å±‚æ•°åç§»çš„æœ€å¤§å€¼ã€‚
- **æœªçŸ¥å¢ƒç•Œ**: åŒ–ç¥ä»¥ä¸Šï¼ˆåŸºç¡€åˆ† 60+ï¼‰è‹¥æ— å…·ä½“æè¿°æˆ–è¢«é€»è¾‘å®ˆå«ï¼ˆFact Guardï¼‰æ‹¦æˆªï¼ŒUI ä¼šç»Ÿä¸€æ˜¾ç¤ºä¸ºâ€œæœªçŸ¥å¢ƒç•Œâ€ã€‚

### 6.11 æ•°æ®åº“ç»´æŠ¤å·¥å…·
- **UI ä½ç½®**: ä¾§è¾¹æ â€œğŸ“š è®°å¿†åº“â€åŒºåŸŸåº•éƒ¨ï¼ˆä½äºå„è®°å¿† Tab çš„ä¸‹æ–¹ï¼‰ã€‚
- **åŠŸèƒ½**:
  - **ä¿®è¡Œç­‰çº§æ ¡å‡†**: `_infer_cultivation_rank` æ‰¹é‡é‡æ–°è®¡ç®—è§’è‰²ç­‰çº§ã€‚
  - **(é¢„ç•™)**: å‘é‡ç´¢å¼•é‡å»ºã€å­¤å„¿æ•°æ®æ¸…ç†ç­‰ã€‚
- **è®¾è®¡æ€è·¯**: é›†ä¸­ç®¡ç†ä½é¢‘ä½†å¿…è¦çš„ç»´æŠ¤æ“ä½œï¼Œé¿å…æ‰“æ‰°ä¸»ç•Œé¢çš„åˆ›ä½œæµã€‚
 - **ç›¸å…³å…¥å£**: â€œğŸ“œ ç« èŠ‚åº“â€ä¹Ÿæ”¾åœ¨åŒä¸€ä½ç½®ï¼ˆä¾§è¾¹æ åº•éƒ¨ï¼‰ï¼Œç‚¹å‡»ååœ¨æ–°çª—å£æ‰“å¼€ç« èŠ‚åº“è§†å›¾ã€‚

### 6.12 åº•éƒ¨å·¥å…·æ  (UI Refactor)
- **ä½ç½®**: ä½äºä¸»ç•Œé¢ç¼–è¾‘å™¨ä¸èŠå¤©è®°å½•ä¹‹é—´ã€‚
- **å¸ƒå±€**: æ¨ªå‘æ’åˆ—çš„ä¸‰ä¸ªåŠŸèƒ½æŒ‰é’®ï¼ˆå¯¼å…¥/RAG/Guardï¼‰ã€‚
- **äº¤äº’**: 
  - é‡‡ç”¨ä¸‹æ‹‰æŠ˜å è®¾è®¡ï¼ˆContainer with Borderï¼‰ã€‚
  - æŒ‰é’®çŠ¶æ€é€šè¿‡ç®­å¤´ï¼ˆâ–¼/â–¶ï¼‰å’Œé¢œè‰²ï¼ˆPrimary/Secondaryï¼‰ç›´è§‚å±•ç¤ºã€‚
  - å±•å¼€åé€šè¿‡ Divider ä¸ä¸‹æ–¹èŠå¤©åŒºæ˜ç¡®åˆ†éš”ã€‚

## 7. å¼€å‘ä¸æ‰©å±•å»ºè®®

1.  **æ·»åŠ æ–° Agent**:
    - åœ¨ `agents/` ä¸‹åˆ›å»ºæ–°æ–‡ä»¶ï¼Œç»§æ‰¿ `BaseAgent`ã€‚
    - åœ¨ `app.py` ä¸­åˆå§‹åŒ–ï¼Œå¹¶åœ¨ `agents/intent_router.py` æˆ– UI æŒ‰é’®ä¸­æ·»åŠ è°ƒç”¨é€»è¾‘ã€‚

2.  **ä¿®æ”¹æ•°æ®ç»“æ„**:
    - å¦‚æœéœ€è¦å­˜å‚¨æ–°çš„æ•°æ®ç±»å‹ï¼ˆå¦‚â€œä»»åŠ¡ç³»ç»Ÿâ€ï¼‰ï¼Œè¯·ä¿®æ”¹ `utils/memory_manager.py`ï¼Œå¢åŠ å¯¹åº”çš„ load/save æ–¹æ³•ï¼Œå¹¶åœ¨ `get_full_context` ä¸­æ³¨å†Œã€‚

3.  **è°ƒæ•´ Prompt**:
    - Agent çš„è¡Œä¸ºä¸»è¦ç”± Prompt å®šä¹‰ã€‚ç›´æ¥ä¿®æ”¹ `agents/*.py` ä¸­çš„ `system_prompt` å­—ç¬¦ä¸²å³å¯è°ƒæ•´ Agent çš„æ€§æ ¼å’Œèƒ½åŠ›ã€‚

4.  **UI è°ƒæ•´**:
    - `app.py` ä½¿ç”¨ Streamlit æ„å»ºã€‚ä¸»è¦é€šè¿‡ `st.session_state` æ§åˆ¶é¡µé¢çŠ¶æ€æµè½¬ï¼ˆå¦‚ `current_step` ä» `ready` -> `brainstorm` -> `drafting`ï¼‰ã€‚

## 8. éƒ¨ç½²æŒ‡å— (Deployment)

æœ¬é¡¹ç›®æ”¯æŒ **Mac å¼€å‘ + æ ‘è“æ´¾éƒ¨ç½²** çš„å·¥ä½œæµã€‚

1.  **ä¸€é”®éƒ¨ç½²**: ä½¿ç”¨ `deploy.sh` è„šæœ¬ï¼Œè‡ªåŠ¨å®Œæˆ Git æäº¤ã€ä»£ç åŒæ­¥ (Rsync) å’Œè¿œç¨‹æœåŠ¡é‡å¯ã€‚
2.  **å…¬ç½‘è®¿é—®**: æ¨èä½¿ç”¨ **Cloudflare Tunnel** å®ç°å†…ç½‘ç©¿é€ï¼Œæ— éœ€å…¬ç½‘ IP å³å¯é€šè¿‡åŸŸåè®¿é—®ã€‚
3.  **è¯¦ç»†æ–‡æ¡£**: è¯·å‚é˜… [docs/ops/DEPLOYMENT.md](../ops/DEPLOYMENT.md)ã€‚

### 8.1 éƒ¨ç½²å˜æ›´ï¼ˆ2026-01-27ï¼‰
æœ¬æ¬¡å˜æ›´æ¶‰åŠéƒ¨ç½²è„šæœ¬ä¸ Streamlit é…ç½®ï¼Œç›®çš„ä¸ºï¼šå‡å°‘å‘Šè­¦ã€é¿å…è·¨å¹³å°è™šæ‹Ÿç¯å¢ƒè¦†ç›–ã€å¹¶è®© systemd è¿è¡Œæ–¹å¼æ›´ç¨³å®šã€‚

1. **Streamlit é…ç½®è¿ç§»**
   - è°ƒæ•´ `.streamlit/config.toml` ä¸ºæ–°ç‰ˆ `[server]` é…ç½®ï¼ˆaddress/port/headlessï¼‰ã€‚
   - åŸå› ï¼šæ—§é…ç½®é¡¹ï¼ˆå¦‚ `global.disableWelcomePrompt`ï¼‰ä¼šäº§ç”Ÿå‘Šè­¦ã€‚
   - å‚è€ƒï¼š[config.toml](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/.streamlit/config.toml)

2. **deploy.shï¼šRsync æ’é™¤ .venv**
   - `deploy.sh` åœ¨ rsync åŒæ­¥æ—¶æ–°å¢æ’é™¤ `.venv`ï¼Œé¿å…æŠŠ Mac çš„è™šæ‹Ÿç¯å¢ƒåŒæ­¥åˆ°æ ‘è“æ´¾ï¼ˆæ¶æ„ä¸åŒä¼šå¯¼è‡´ä¾èµ–æŸåï¼‰ã€‚
   - å‚è€ƒï¼š[deploy.sh](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/deploy.sh)

3. **systemd æ¨èæ”¹ä¸ºç›´æ¥è¿è¡Œ run.sh**
   - éƒ¨ç½²æ–‡æ¡£æ›´æ–°ä¸ºåœ¨ systemd ä¸­ä½¿ç”¨ `ExecStart=/bin/bash /home/pi/FantasyNovelAgent/run.sh`ã€‚
   - å¥½å¤„ï¼šè‡ªåŠ¨åˆ›å»º/æ›´æ–° `.venv` å¹¶å¯åŠ¨ï¼Œå‡å°‘â€œä¾èµ–ä¸åŒæ­¥â€å¯¼è‡´çš„å¯åŠ¨å¤±è´¥ã€‚
   - å‚è€ƒï¼š[docs/ops/DEPLOYMENT.md](../ops/DEPLOYMENT.md)

4. **æ•°æ®åŒæ­¥ä¸æ•°æ®è¿ç§»çš„é¡ºåºæé†’**
   - `deploy.sh` åœ¨åŒæ­¥ä»£ç å‰ä¼šè°ƒç”¨ `sync_data.sh`ï¼Œå®ƒä¼šæŠŠæ ‘è“æ´¾ä¸Šçš„ `data/novel.db` æ‹‰å›è¦†ç›–æœ¬æœºå¯¹åº”æ–‡ä»¶ã€‚
   - å¦‚æœå½“å¤©åšè¿‡æ•°æ®åº“æ”¹é€ /è¿ç§»ï¼Œä¸”æ”¹é€ ç»“æœåªå­˜åœ¨äºæœ¬æœºï¼Œå…ˆä¸è¦ç›´æ¥è·‘ deployï¼›åº”å…ˆåœ¨æ ‘è“æ´¾ä¸Šå®Œæˆè¿ç§»æˆ–å…ˆå¤‡ä»½æœ¬æœºæ•°æ®åº“ã€‚
   - å‚è€ƒï¼š[sync_data.sh](file:///Users/sun/Desktop/chenfeng/editor/FantasyNovelAgent/sync_data.sh)

## 9. å¿«é€Ÿå¯åŠ¨

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥ OPENAI_API_KEY ç­‰ä¿¡æ¯

# 3. å¯åŠ¨åº”ç”¨
streamlit run app.py
```
